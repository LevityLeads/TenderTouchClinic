---
phase: 03-contact-and-forms
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - package.json
  - src/lib/validations/contact.ts
  - src/app/actions/contact.ts
  - src/components/forms/contact-form.tsx
  - src/app/contact/page.tsx
  - .env.local.example
autonomous: true
user_setup:
  - service: resend
    why: "Transactional email delivery for contact form notifications"
    env_vars:
      - name: RESEND_API_KEY
        source: "Resend Dashboard -> API Keys -> Create API Key"
      - name: CONTACT_EMAIL
        source: "Email address where form submissions should be sent (e.g., tendertouch.ct@gmail.com)"
    dashboard_config:
      - task: "Verify sending domain (optional for production)"
        location: "Resend Dashboard -> Domains -> Add Domain"

must_haves:
  truths:
    - "Visitor can submit contact form with name, phone, email, preferred time, and message"
    - "Form shows validation errors for invalid input"
    - "Form shows success message after submission"
    - "Form collects NO medical information (HIPAA-aware)"
    - "Clinic receives email notification when form is submitted"
  artifacts:
    - path: "src/lib/validations/contact.ts"
      provides: "Zod schema for form validation"
      exports: ["contactFormSchema", "ContactFormData"]
    - path: "src/app/actions/contact.ts"
      provides: "Server Action for form submission"
      exports: ["submitContactForm", "ContactFormState"]
    - path: "src/components/forms/contact-form.tsx"
      provides: "Client component with form UI"
      exports: ["ContactForm"]
  key_links:
    - from: "src/components/forms/contact-form.tsx"
      to: "src/lib/validations/contact.ts"
      via: "schema import for client validation"
      pattern: "import.*contactFormSchema"
    - from: "src/app/actions/contact.ts"
      to: "src/lib/validations/contact.ts"
      via: "schema import for server validation"
      pattern: "import.*contactFormSchema"
    - from: "src/components/forms/contact-form.tsx"
      to: "src/app/actions/contact.ts"
      via: "useActionState hook"
      pattern: "useActionState.*submitContactForm"
    - from: "src/app/actions/contact.ts"
      to: "resend"
      via: "Resend API call"
      pattern: "resend\\.emails\\.send"
---

<objective>
Implement the contact form with client-side validation (React Hook Form + Zod), server-side processing (Server Actions), and email notifications (Resend).

Purpose: Visitors need a way to send inquiries to the clinic with immediate feedback on form validity and confirmation of successful submission.

Output: Working contact form that validates input, submits via Server Action, sends email notification, and shows success/error feedback.
</objective>

<execution_context>
@/home/codespace/.claude/get-shit-done/workflows/execute-plan.md
@/home/codespace/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-contact-&-forms/03-RESEARCH.md
@.planning/phases/03-contact-&-forms/03-01-SUMMARY.md

# Contact page from Plan 01
@src/app/contact/page.tsx

# Existing UI patterns
@src/components/ui/button.tsx
@src/components/ui/section.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create validation schema</name>
  <files>package.json, src/lib/validations/contact.ts, .env.local.example</files>
  <action>
  Install required packages:
  ```bash
  pnpm add react-hook-form zod @hookform/resolvers resend
  ```

  Create `src/lib/validations/contact.ts`:
  ```typescript
  import { z } from "zod";

  export const contactFormSchema = z.object({
    name: z
      .string()
      .min(1, "Name is required")
      .max(100, "Name must be less than 100 characters"),
    email: z
      .string()
      .min(1, "Email is required")
      .email("Please enter a valid email address"),
    phone: z
      .string()
      .min(10, "Phone number must be at least 10 digits")
      .regex(/^[0-9+\-\s()]+$/, "Please enter a valid phone number"),
    preferredTime: z.enum(["morning", "afternoon", "evening", "any"], {
      required_error: "Please select a preferred contact time",
    }),
    message: z
      .string()
      .min(10, "Message must be at least 10 characters")
      .max(1000, "Message must be less than 1000 characters"),
    honeypot: z.string().max(0, "Bot detected"), // Must be empty
  });

  export type ContactFormData = z.infer<typeof contactFormSchema>;

  // Time options for the select dropdown
  export const preferredTimeOptions = [
    { value: "morning", label: "Morning (8AM - 12PM)" },
    { value: "afternoon", label: "Afternoon (12PM - 5PM)" },
    { value: "evening", label: "Evening (after 5PM)" },
    { value: "any", label: "Any time" },
  ] as const;
  ```

  Create `.env.local.example`:
  ```
  # Resend API Key - get from https://resend.com/api-keys
  RESEND_API_KEY=re_xxxxxxxxxxxx

  # Email address to receive contact form submissions
  CONTACT_EMAIL=tendertouch.ct@gmail.com

  # Google Maps API Key (optional - map works without key but shows watermark)
  NEXT_PUBLIC_GOOGLE_MAPS_KEY=
  ```
  </action>
  <verify>
  Dependencies installed and schema compiles:
  ```bash
  grep "react-hook-form" package.json && npx tsc --noEmit src/lib/validations/contact.ts
  ```
  </verify>
  <done>react-hook-form, zod, @hookform/resolvers, resend installed. Validation schema exports contactFormSchema and ContactFormData.</done>
</task>

<task type="auto">
  <name>Task 2: Create Server Action for form submission</name>
  <files>src/app/actions/contact.ts</files>
  <action>
  Create `src/app/actions/contact.ts` with "use server" directive:

  ```typescript
  "use server";

  import { contactFormSchema } from "@/lib/validations/contact";
  import { Resend } from "resend";

  const resend = new Resend(process.env.RESEND_API_KEY);

  export type ContactFormState = {
    success: boolean;
    message: string;
    errors?: Record<string, string[]>;
  };

  export async function submitContactForm(
    prevState: ContactFormState,
    formData: FormData
  ): Promise<ContactFormState> {
    // Check honeypot first (spam protection)
    const honeypot = formData.get("honeypot");
    if (honeypot) {
      // Silently accept but don't process (bot detected)
      return { success: true, message: "Thank you for your message!" };
    }

    const rawData = {
      name: formData.get("name"),
      email: formData.get("email"),
      phone: formData.get("phone"),
      preferredTime: formData.get("preferredTime"),
      message: formData.get("message"),
      honeypot: formData.get("honeypot") ?? "",
    };

    // Server-side validation with same schema
    const result = contactFormSchema.safeParse(rawData);

    if (!result.success) {
      return {
        success: false,
        message: "Please correct the errors below.",
        errors: result.error.flatten().fieldErrors as Record<string, string[]>,
      };
    }

    // Send email notification
    try {
      const { data: formValues } = result;

      await resend.emails.send({
        from: "Tender Touch Clinic <noreply@resend.dev>", // Using Resend's test domain
        to: [process.env.CONTACT_EMAIL || "tendertouch.ct@gmail.com"],
        replyTo: formValues.email,
        subject: `New Contact Form Submission from ${formValues.name}`,
        text: `
New contact form submission:

Name: ${formValues.name}
Email: ${formValues.email}
Phone: ${formValues.phone}
Preferred Contact Time: ${formValues.preferredTime}

Message:
${formValues.message}

---
Submitted via Tender Touch Clinic website contact form
        `.trim(),
      });

      return {
        success: true,
        message: "Thank you for your message! We'll be in touch soon.",
      };
    } catch (error) {
      console.error("Failed to send contact form email:", error);
      return {
        success: false,
        message:
          "Something went wrong. Please try again or call us directly at 083 564 1671.",
      };
    }
  }
  ```

  Key points:
  - Use same Zod schema for server validation
  - Honeypot check before processing
  - Plain text email (no React Email dependency for simplicity)
  - Fallback message with phone number if email fails
  - Reply-to set to submitter's email for easy reply
  </action>
  <verify>
  TypeScript compiles:
  ```bash
  npx tsc --noEmit src/app/actions/contact.ts
  ```
  </verify>
  <done>Server Action validates form data, checks honeypot, sends email via Resend, returns typed state.</done>
</task>

<task type="auto">
  <name>Task 3: Create contact form component and integrate into page</name>
  <files>src/components/forms/contact-form.tsx, src/app/contact/page.tsx</files>
  <action>
  Create `src/components/forms/contact-form.tsx` as a Client Component:

  ```typescript
  "use client";

  import { useForm } from "react-hook-form";
  import { zodResolver } from "@hookform/resolvers/zod";
  import { useActionState } from "react";
  import {
    contactFormSchema,
    type ContactFormData,
    preferredTimeOptions,
  } from "@/lib/validations/contact";
  import {
    submitContactForm,
    type ContactFormState,
  } from "@/app/actions/contact";
  import { Button } from "@/components/ui/button";

  const initialState: ContactFormState = {
    success: false,
    message: "",
  };

  export function ContactForm() {
    const [state, formAction, pending] = useActionState(
      submitContactForm,
      initialState
    );

    const {
      register,
      formState: { errors },
    } = useForm<ContactFormData>({
      resolver: zodResolver(contactFormSchema),
      mode: "onBlur", // Validate on blur for progressive disclosure
    });

    // Show success state
    if (state.success && state.message) {
      return (
        <div
          className="rounded-lg border border-green-200 bg-green-50 p-8 text-center"
          role="status"
          aria-live="polite"
        >
          <h3 className="text-lg font-semibold text-green-800">
            Message Sent!
          </h3>
          <p className="mt-2 text-green-700">{state.message}</p>
        </div>
      );
    }

    return (
      <form action={formAction} className="space-y-6">
        {/* Honeypot field - hidden from users, visible to bots */}
        <input
          type="text"
          {...register("honeypot")}
          className="absolute -left-[9999px]"
          tabIndex={-1}
          autoComplete="off"
          aria-hidden="true"
        />

        {/* Privacy notice */}
        <p className="text-sm text-gray-600">
          We will only use your information to respond to your inquiry.
          See our{" "}
          <a href="/privacy" className="text-primary hover:underline">
            Privacy Policy
          </a>
          .
        </p>

        {/* Name field */}
        <div>
          <label
            htmlFor="name"
            className="block text-sm font-medium text-gray-700"
          >
            Name <span className="text-red-500">*</span>
          </label>
          <input
            {...register("name")}
            type="text"
            id="name"
            name="name"
            className="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:border-primary focus:outline-none focus:ring-1 focus:ring-primary"
            aria-describedby={errors.name ? "name-error" : undefined}
            aria-invalid={errors.name ? "true" : "false"}
          />
          {(errors.name || state.errors?.name) && (
            <p id="name-error" className="mt-1 text-sm text-red-600" role="alert">
              {errors.name?.message || state.errors?.name?.[0]}
            </p>
          )}
        </div>

        {/* Email field */}
        <div>
          <label
            htmlFor="email"
            className="block text-sm font-medium text-gray-700"
          >
            Email <span className="text-red-500">*</span>
          </label>
          <input
            {...register("email")}
            type="email"
            id="email"
            name="email"
            className="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:border-primary focus:outline-none focus:ring-1 focus:ring-primary"
            aria-describedby={errors.email ? "email-error" : undefined}
            aria-invalid={errors.email ? "true" : "false"}
          />
          {(errors.email || state.errors?.email) && (
            <p id="email-error" className="mt-1 text-sm text-red-600" role="alert">
              {errors.email?.message || state.errors?.email?.[0]}
            </p>
          )}
        </div>

        {/* Phone field */}
        <div>
          <label
            htmlFor="phone"
            className="block text-sm font-medium text-gray-700"
          >
            Phone <span className="text-red-500">*</span>
          </label>
          <input
            {...register("phone")}
            type="tel"
            id="phone"
            name="phone"
            className="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:border-primary focus:outline-none focus:ring-1 focus:ring-primary"
            aria-describedby={errors.phone ? "phone-error" : undefined}
            aria-invalid={errors.phone ? "true" : "false"}
          />
          {(errors.phone || state.errors?.phone) && (
            <p id="phone-error" className="mt-1 text-sm text-red-600" role="alert">
              {errors.phone?.message || state.errors?.phone?.[0]}
            </p>
          )}
        </div>

        {/* Preferred time field */}
        <div>
          <label
            htmlFor="preferredTime"
            className="block text-sm font-medium text-gray-700"
          >
            Preferred Contact Time <span className="text-red-500">*</span>
          </label>
          <select
            {...register("preferredTime")}
            id="preferredTime"
            name="preferredTime"
            className="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:border-primary focus:outline-none focus:ring-1 focus:ring-primary"
            aria-describedby={errors.preferredTime ? "preferredTime-error" : undefined}
            aria-invalid={errors.preferredTime ? "true" : "false"}
          >
            <option value="">Select a time...</option>
            {preferredTimeOptions.map((option) => (
              <option key={option.value} value={option.value}>
                {option.label}
              </option>
            ))}
          </select>
          {(errors.preferredTime || state.errors?.preferredTime) && (
            <p id="preferredTime-error" className="mt-1 text-sm text-red-600" role="alert">
              {errors.preferredTime?.message || state.errors?.preferredTime?.[0]}
            </p>
          )}
        </div>

        {/* Message field */}
        <div>
          <label
            htmlFor="message"
            className="block text-sm font-medium text-gray-700"
          >
            Message <span className="text-red-500">*</span>
          </label>
          <textarea
            {...register("message")}
            id="message"
            name="message"
            rows={5}
            className="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:border-primary focus:outline-none focus:ring-1 focus:ring-primary"
            aria-describedby={errors.message ? "message-error" : undefined}
            aria-invalid={errors.message ? "true" : "false"}
          />
          {(errors.message || state.errors?.message) && (
            <p id="message-error" className="mt-1 text-sm text-red-600" role="alert">
              {errors.message?.message || state.errors?.message?.[0]}
            </p>
          )}
        </div>

        {/* Server error message */}
        {!state.success && state.message && (
          <p className="text-sm text-red-600" role="alert" aria-live="polite">
            {state.message}
          </p>
        )}

        {/* Submit button */}
        <Button type="submit" disabled={pending} className="w-full">
          {pending ? "Sending..." : "Send Message"}
        </Button>
      </form>
    );
  }
  ```

  Update `src/app/contact/page.tsx` to add the form section:
  - Add a new Section with heading "Send Us a Message"
  - Import and render ContactForm component
  - Add note below form: "No medical information collected via this form"
  - Place form section after contact info but before directions
  </action>
  <verify>
  Build succeeds and form renders:
  ```bash
  pnpm build
  ```
  </verify>
  <done>Contact form validates on blur, submits via Server Action, shows validation errors with ARIA, displays success state. Form integrated into contact page with privacy notice and HIPAA-aware disclaimer.</done>
</task>

</tasks>

<verification>
1. Navigate to `/contact` - form displays below contact info
2. Submit empty form - all required field errors show
3. Enter invalid email - shows "Please enter a valid email address"
4. Enter short phone - shows "Phone number must be at least 10 digits"
5. Enter short message - shows "Message must be at least 10 characters"
6. Fill valid data and submit - form shows pending state, then success message
7. Check server logs - email sent (or Resend API called)
8. Privacy notice visible with link to /privacy
9. All form fields have proper labels and aria attributes
10. Tab through form - keyboard navigation works
11. Screen reader announces errors (role="alert")
12. Build passes: `pnpm build`
</verification>

<success_criteria>
- [ ] Form renders with all required fields (name, email, phone, preferredTime, message)
- [ ] Client-side validation shows errors on blur
- [ ] Server-side validation catches invalid data
- [ ] Honeypot field hidden from users (spam protection)
- [ ] Form submission sends email via Resend (or logs error if no API key)
- [ ] Success state replaces form after successful submission
- [ ] Privacy notice visible with link to policy
- [ ] No medical information fields (HIPAA-aware)
- [ ] All form elements have proper ARIA attributes
- [ ] Build succeeds: `pnpm build`
</success_criteria>

<output>
After completion, create `.planning/phases/03-contact-&-forms/03-02-SUMMARY.md`
</output>
